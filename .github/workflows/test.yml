name: "Test"
on:
  pull_request:
  push:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: "Initial nix-shell run"
        run: nix-shell --run "echo \"Initial nix-shell run\""
        shell: bash

      - name: Check nix lint
        run: nix-shell --run "statix check"
        shell: bash
      - name: Run nixpkgs-fmt check
        run: nix-shell --run "nixpkgs-fmt --check ./**/*.nix"
        shell: bash

      - name: Run luacheck
        run: nix-shell --run "luacheck --config \"./codestyle/.luacheckrc.lua\" \"./home-configs/hammerspoon\""
        shell: bash
      - name: Run lua-format
        run: nix-shell --run "find \"home-configs/hammerspoon\" -type f -name \"*.lua\" -exec lua-format -i --config=\"./codestyle/lua-format-config.yml\" {} +"
        shell: bash
      - name: Check for changed files - fails if there is a git diff
        run: nix-shell --run "git diff --quiet"
        shell: bash
